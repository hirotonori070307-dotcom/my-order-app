<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>レジ</title>
    <style>
        body { font-family: sans-serif; padding: 10px; display: flex; gap: 10px; }
        .column { flex: 1; height: 95vh; overflow-y: auto; border: 1px solid #eee; padding: 10px; }
        .order-list { list-style: none; padding: 0; }
        .order-item { padding: 15px; margin-bottom: 15px; border-radius: 8px; border: 2px solid; }
        
        /* 支払い待ち（厨房から来たもの） */
        .pending { border-color: #ffc107; background: #fffaf0; }
        /* 提供済み */
        .done { border-color: #6c757d; background: #f8f9fa; opacity: 0.8; }

        .btn-pay { background-color: #007bff; color: white; padding: 10px; border: none; font-size: 1.1em; cursor: pointer; width: 100%; }
    </style>
</head>
<body>
    <div class="column">
        <h1>お会計待ち (呼び出し済み)</h1>
        <ul id="pending-list" class="order-list"></ul>
    </div>
    <div class="column">
        <h1>提供済み履歴</h1>
        <ul id="done-list" class="order-list"></ul>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        const pendingList = document.getElementById('pending-list');
        const doneList = document.getElementById('done-list');

        function createItem(order) {
            const li = document.createElement('li');
            li.id = `cashier-order-${order.id}`;
            
            let itemsHtml = '<ul>';
            let total = 0;
            order.items.forEach(i => {
                itemsHtml += `<li>${i.name} (${i.price}円) x ${i.quantity}</li>`;
                total += i.price * i.quantity;
            });
            itemsHtml += '</ul>';

            if (order.status === '支払い待ち') {
                li.className = 'order-item pending';
                li.innerHTML = `
                    <h3>注文番号: ${order.id}</h3>
                    ${itemsHtml}
                    <div style="font-weight:bold; font-size:1.2em; margin:10px 0;">合計: ${total}円</div>
                    <button class="btn-pay" onclick="confirmPay(${order.id})">支払い完了 & 提供</button>
                `;
            } else {
                li.className = 'order-item done';
                li.innerHTML = `<h3>注文番号: ${order.id} (済)</h3>${itemsHtml}<div>合計: ${total}円</div>`;
            }
            return li;
        }

        function renderOrder(order) {
            // 既存削除
            const old = document.getElementById(`cashier-order-${order.id}`);
            if (old) old.remove();

            // 調理中はレジに表示しない
            if (order.status === '調理中') return;

            const li = createItem(order);
            if (order.status === '支払い待ち') pendingList.prepend(li);
            else if (order.status === '提供済み') doneList.prepend(li);
        }

        socket.on('initial_orders', (orders) => {
            orders.forEach(o => renderOrder(o));
        });
        socket.on('new_pending_order', (order) => renderOrder(order));
        socket.on('status_updated', (order) => renderOrder(order));

        function confirmPay(id) {
            if(!confirm('支払いを完了し、提供済みにしますか？')) return;
            socket.emit('confirm_payment', { id });
        }
    </script>
</body>
</html>
