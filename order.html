<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>注文画面</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        body { font-family: sans-serif; padding: 20px; padding-bottom: 80px; }
        .menu-item { border: 1px solid #ccc; padding: 10px; margin-bottom: 10px; }
        .price { font-weight: bold; color: #d9534f; }
        button { padding: 10px; cursor: pointer; font-size: 1.1em; }
        
        #message { margin-top: 20px; padding: 15px; font-weight: bold; text-align: center; display: none; }
        .msg-cooking { background: #e2e3e5; color: #383d41; border: 2px solid #d6d8db; }
        
        /* アラーム画面 */
        #alarm-modal {
            display: none;
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(255, 0, 0, 0.95);
            color: white; z-index: 9999;
            flex-direction: column; justify-content: center; align-items: center;
            text-align: center;
        }
        #alarm-modal h1 { font-size: 3em; margin-bottom: 20px; animation: shake 0.5s infinite; }
        #stop-alarm-btn {
            font-size: 1.5em; padding: 20px 40px; background: white; color: red;
            border: none; border-radius: 50px; font-weight: bold; box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        @keyframes shake {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            50% { transform: translate(-1px, 2px) rotate(-1deg); }
            100% { transform: translate(1px, -2px) rotate(-1deg); }
        }

        #receipt { border: 2px dashed #333; background: #fafafa; padding: 15px; margin-top: 20px; }
        .quantity-btn { padding: 5px 10px; margin: 0 5px; }
    </style>
</head>
<body>
    <div id="alarm-modal">
        <h1>出来上がり！</h1>
        <p style="font-size: 1.2em;">ピロティ２番　ＩＴビジネス学科１年　受取口まで<br>お越しください。</p>
        <button id="stop-alarm-btn">音を止めて確認する</button>
    </div>

    <div id="main-view">
        <h1>ご注文</h1>
        <div id="menu-area">
            <div class="menu-item">
                <h3>牛串</h3><p>★乳成分を含みます★</p><p class="price">500円</p>
                <button class="add-to-cart" data-name="牛串" data-price="500">カートに入れる</button>
            </div>
        </div>
        <h2>カート</h2>
        <ul id="cart-list"></ul>
        <div id="total">合計: 0円</div>
        <button id="submit-order" style="width:100%; margin-top:10px;">注文する</button>
    </div>

    <div id="message"></div>
    <div id="receipt-area"></div>

    <script>
        window.addEventListener('load', function() {
            // --- 設定 ---
            const socket = io();
            const VAPID_PUBLIC_KEY = 'BAoAi-ufJ4-0DmT7deTIt7XciP2h2uaIT298QxdfBn3YCkM-11mpduc9hkyyHUEUwXqmd-F3it0__q-BDW0-kUk'; 
            let cart = [];
            
            // ★★★ 音声エンジン (Global) ★★★
            // AudioContextはページの読み込み後、最初のタッチで作成するのが鉄則
            let audioCtx = null;
            let audioUnlocked = false;

            // --- 1. 音声機能の強力な初期化 ---
            function enableAudio() {
                if (audioUnlocked) return; // 既に有効なら何もしない

                const AudioContext = window.AudioContext || window.webkitAudioContext;
                if (!AudioContext) return;

                if (!audioCtx) audioCtx = new AudioContext();

                // 停止中なら再開
                if (audioCtx.state === 'suspended') {
                    audioCtx.resume().then(() => {
                        console.log("Audio resumed");
                    });
                }

                // 無音のバッファを再生して、ブラウザに「音を出していいよ」と認識させる
                const buffer = audioCtx.createBuffer(1, 1, 22050);
                const source = audioCtx.createBufferSource();
                source.buffer = buffer;
                source.connect(audioCtx.destination);
                source.start(0);

                audioUnlocked = true;
                console.log("Audio Unlocked!");
                
                // イベントリスナーを削除（1回やれば十分なので）
                document.removeEventListener('click', enableAudio);
                document.removeEventListener('touchstart', enableAudio);
            }

            // ★ 画面のどこを触っても、最初の1回で音声を有効化する
            document.addEventListener('click', enableAudio);
            document.addEventListener('touchstart', enableAudio);


            // --- 2. ビープ音再生関数 ---
            function playBeep() {
                if (!audioCtx) enableAudio(); // 念のため
                if (!audioCtx) return;

                const oscillator = audioCtx.createOscillator();
                const gainNode = audioCtx.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(audioCtx.destination);

                oscillator.type = 'square';
                oscillator.frequency.setValueAtTime(880, audioCtx.currentTime); // ラの音
                
                // 音量制御 (0.3秒でフェードアウト)
                gainNode.gain.setValueAtTime(0.5, audioCtx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);

                oscillator.start();
                oscillator.stop(audioCtx.currentTime + 0.3);

                // バイブレーション (Android等)
                if (navigator.vibrate) navigator.vibrate(500);
            }

            // --- 3. アラーム制御 ---
            let alarmInterval = null;
            const alarmModal = document.getElementById('alarm-modal');

            function startAlarm() {
                alarmModal.style.display = 'flex';
                // iOS対策: アラーム開始時にも resume を試みる
                if(audioCtx && audioCtx.state === 'suspended') audioCtx.resume();
                
                playPattern();
                if (alarmInterval) clearInterval(alarmInterval);
                alarmInterval = setInterval(playPattern, 2500);
            }

            function playPattern() {
                playBeep();
                setTimeout(playBeep, 400);
                setTimeout(playBeep, 800);
            }

            document.getElementById('stop-alarm-btn').addEventListener('click', function() {
                alarmModal.style.display = 'none';
                if (alarmInterval) {
                    clearInterval(alarmInterval);
                    alarmInterval = null;
                }
            });


            // --- 4. カート機能 ---
            const cartList = document.getElementById('cart-list');
            const totalDiv = document.getElementById('total');

            document.querySelectorAll('.add-to-cart').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    // ★ カートボタンを押した時点でも音声を有効化
                    enableAudio();
                    
                    const name = e.target.getAttribute('data-name');
                    const price = parseInt(e.target.getAttribute('data-price'));
                    
                    const exist = cart.find(i => i.name === name);
                    if(exist) {
                        exist.quantity++;
                    } else {
                        cart.push({name: name, price: price, quantity: 1});
                    }
                    renderCart();
                });
            });

            function renderCart() {
                cartList.innerHTML = '';
                let t = 0;
                cart.forEach((i, idx) => {
                    const li = document.createElement('li');
                    li.innerHTML = `${i.name} - ${i.price}円 x ${i.quantity} 
                        <button class="quantity-btn" data-idx="${idx}" data-act="plus">+</button>
                        <button class="quantity-btn" data-idx="${idx}" data-act="minus">-</button>`;
                    cartList.appendChild(li);
                    t += i.price * i.quantity;
                });
                totalDiv.innerText = `合計: ${t}円`;
                
                document.querySelectorAll('.quantity-btn').forEach(btn => {
                    btn.addEventListener('click', function(e) {
                        enableAudio(); // 数量変更時も念のため
                        const idx = parseInt(e.target.getAttribute('data-idx'));
                        const act = e.target.getAttribute('data-act');
                        if (act === 'plus') {
                            cart[idx].quantity++;
                        } else {
                            cart[idx].quantity--;
                            if(cart[idx].quantity <= 0) cart.splice(idx, 1);
                        }
                        renderCart();
                    });
                });
            }


            // --- 5. 画面更新 ---
            const savedId = localStorage.getItem('myOrderId');
            if(savedId) {
                fetch(`/api/order/${savedId}`)
                    .then(res => res.ok ? res.json() : null)
                    .then(order => {
                        if(order) {
                            socket.emit('register_customer', { orderId: order.id });
                            updateScreen(order);
                        } else {
                            localStorage.removeItem('myOrderId');
                        }
                    });
            }

            function updateScreen(order) {
                const mainView = document.getElementById('main-view');
                const msgDiv = document.getElementById('message');
                const receiptArea = document.getElementById('receipt-area');

                mainView.style.display = 'none';
                msgDiv.style.display = 'block';

                if (order.status === '調理中') {
                    msgDiv.className = 'msg-cooking';
                    msgDiv.innerHTML = `注文番号: <strong>${order.id}</strong><br>只今調理中です。<br>そのままお待ちください。`;
                    receiptArea.innerHTML = '';
                
                } else if (order.status === '支払い待ち') {
                    // 呼び出し中
                    msgDiv.style.display = 'none';
                    receiptArea.innerHTML = `
                        <div style="text-align:center; padding:20px; font-weight:bold; font-size:1.2em; line-height:1.6;">
                            ご注文の商品が準備できました。<br>
                            <span style="color:#d9534f; font-size:1.3em;">ピロティ②番、受取口</span>にて<br>
                            お支払いをお願いいたします。
                        </div>
                    `;
                    startAlarm();

                } else if (order.status === '提供済み') {
                    alarmModal.style.display = 'none';
                    if (alarmInterval) clearInterval(alarmInterval);
                    msgDiv.style.display = 'none';
                    showReceipt(order);
                }
            }

            function showReceipt(order) {
                let total = 0;
                let list = '';
                order.items.forEach(i => {
                    list += `<li>${i.name} x ${i.quantity}</li>`;
                    total += i.price * i.quantity;
                });
                document.getElementById('receipt-area').innerHTML = `
                    <div id="receipt">
                        <h2 style="text-align:center;">領収書</h2>
                        <p>注文番号: ${order.id}</p>
                        <p>日付: ${new Date(order.createdAt).toLocaleString()}</p>
                        <hr><ul>${list}</ul><hr>
                        <h3 style="text-align:right;">合計: ${total}円</h3>
                    </div>
                    <button id="btn-new-order" style="width:100%; background:#007bff; color:white; border:none; margin-top:20px; padding:15px; border-radius:5px; font-size:1.2em;">新しい注文をする</button>
                `;
                document.getElementById('btn-new-order').addEventListener('click', function() {
                    if(confirm('トップに戻りますか？')) {
                        localStorage.removeItem('myOrderId');
                        location.reload();
                    }
                });
            }


            // --- 6. 注文送信 ---
            document.getElementById('submit-order').addEventListener('click', async function() {
                if(cart.length === 0) return alert('カートが空です');
                
                // ★ ここが最後の砦：注文ボタンを押した瞬間にも確実に有効化
                enableAudio();

                const res = await fetch('/api/order', {
                    method:'POST', headers:{'Content-Type':'application/json'},
                    body: JSON.stringify({ items: cart })
                });
                const data = await res.json();
                
                if(res.ok) {
                    localStorage.setItem('myOrderId', data.orderId);
                    socket.emit('register_customer', { orderId: data.orderId });
                    
                    if ('serviceWorker' in navigator) {
                        navigator.serviceWorker.register('/service-worker.js').then(reg => {
                            Notification.requestPermission().then(perm => {
                                if(perm === 'granted') {
                                    reg.pushManager.subscribe({userVisibleOnly:true, applicationServerKey: VAPID_PUBLIC_KEY})
                                        .then(sub => {
                                            fetch('/api/subscribe', {method:'POST', body:JSON.stringify({subscription:sub, orderId: data.orderId}), headers:{'Content-Type':'application/json'}});
                                        });
                                }
                            });
                        });
                    }
                    updateScreen({ id: data.orderId, status: '調理中', items: cart });
                }
            });


            // --- Socket イベント ---
            socket.on('order_ready', () => { startAlarm(); });
            socket.on('payment_confirmed', (order) => { updateScreen(order); });
            socket.on('status_updated', (order) => {
                const oid = localStorage.getItem('myOrderId');
                if(oid && parseInt(oid) === order.id) updateScreen(order);
            });
        
        });
    </script>
</body>
</html>
