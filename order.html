<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>注文画面</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        body { font-family: sans-serif; padding: 20px; padding-bottom: 80px; }
        .menu-item { border: 1px solid #ccc; padding: 10px; margin-bottom: 10px; }
        .price { font-weight: bold; color: #d9534f; }
        button { padding: 10px; cursor: pointer; font-size: 1.1em; }
        
        #message { margin-top: 20px; padding: 15px; font-weight: bold; text-align: center; display: none; }
        .msg-cooking { background: #e2e3e5; color: #383d41; border: 2px solid #d6d8db; }
        
        /* アラーム画面（赤背景） */
        #alarm-modal {
            display: none;
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(255, 0, 0, 0.95);
            color: white; z-index: 9999;
            flex-direction: column; justify-content: center; align-items: center;
            text-align: center;
        }
        #alarm-modal h1 { font-size: 3em; margin-bottom: 20px; animation: shake 0.5s infinite; }
        #stop-alarm-btn {
            font-size: 1.5em; padding: 20px 40px; background: white; color: red;
            border: none; border-radius: 50px; font-weight: bold; box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        @keyframes shake {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            50% { transform: translate(-1px, 2px) rotate(-1deg); }
            100% { transform: translate(1px, -2px) rotate(-1deg); }
        }

        #receipt { border: 2px dashed #333; background: #fafafa; padding: 15px; margin-top: 20px; }
        #btn-new-order { width: 100%; background: #007bff; color: white; border: none; margin-top: 20px; }
        .quantity-btn { padding: 5px 10px; margin: 0 5px; }
    </style>
</head>
<body>
    <div id="alarm-modal">
        <h1>出来上がり！</h1>
        <p>注文番号の呼び出しです。<br>カウンターへお越しください。</p>
        <button id="stop-alarm-btn" onclick="stopAlarm()">音を止めて確認する</button>
    </div>

    <div id="main-view">
        <h1>ご注文</h1>
        <div id="menu-area">
            <div class="menu-item">
                <h3>商品A</h3><p class="price">500円</p>
                <button class="add-to-cart" data-name="商品A" data-price="500">カートに入れる</button>
            </div>
            <div class="menu-item">
                <h3>商品B</h3><p class="price">800円</p>
                <button class="add-to-cart" data-name="商品B" data-price="800">カートに入れる</button>
            </div>
        </div>
        <h2>カート</h2>
        <ul id="cart-list"></ul>
        <div id="total">合計: 0円</div>
        <button id="submit-order" style="width:100%; margin-top:10px;">注文する</button>
    </div>

    <div id="message"></div>
    <div id="receipt-area"></div>

    <script>
        const socket = io();
        const VAPID_PUBLIC_KEY = 'BAoAi-ufJ4-0DmT7deTIt7XciP2h2uaIT298QxdfBn3YCkM-11mpduc9hkyyHUEUwXqmd-F3it0__q-BDW0-kUk'; 
        
        let cart = [];
        let alarmInterval = null;

        // ★★★ ビープ音作成用 (AudioContext) ★★★
        let audioCtx = null;

        function initAudio() {
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            }
        }

        // ★★★ 電子音(ビープ)を鳴らす関数 ★★★
        function playBeep() {
            if (!audioCtx) initAudio();
            
            // 音の発生源を作成
            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();

            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);

            // 音色と高さの設定
            oscillator.type = 'square'; // 'square'は「ピッ」という電子音らしい音
            oscillator.frequency.value = 880; // 高さ (Hz)

            // 音量の設定 (フェードアウト)
            gainNode.gain.setValueAtTime(0.5, audioCtx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);

            // 再生開始と停止
            oscillator.start();
            oscillator.stop(audioCtx.currentTime + 0.3);

            // バイブレーション (対応スマホのみ)
            if (navigator.vibrate) navigator.vibrate(300);
        }

        // ★ アラーム開始 (ビープ音を連打)
        function startAlarm() {
            const modal = document.getElementById('alarm-modal');
            modal.style.display = 'flex';
            
            if (!audioCtx) initAudio();
            if (audioCtx.state === 'suspended') audioCtx.resume();

            // 最初の1回
            playOneAlarmCycle();

            if (alarmInterval) clearInterval(alarmInterval);
            // 2秒ごとに音のセットを鳴らす
            alarmInterval = setInterval(playOneAlarmCycle, 2000);
        }

        // 「ピッ！ピッ！ピッ！」というリズムを作る
        function playOneAlarmCycle() {
            playBeep();
            setTimeout(playBeep, 400); // 0.4秒後にもう一回
            setTimeout(playBeep, 800); // 0.8秒後にもう一回
        }

        // ★ アラーム停止
        function stopAlarm() {
            document.getElementById('alarm-modal').style.display = 'none';
            if (alarmInterval) {
                clearInterval(alarmInterval);
                alarmInterval = null;
            }
        }

        // 初期化
        document.addEventListener('DOMContentLoaded', async () => {
            const savedId = localStorage.getItem('myOrderId');
            if(savedId) {
                const res = await fetch(`/api/order/${savedId}`);
                if(res.ok) {
                    const order = await res.json();
                    socket.emit('register_customer', { orderId: order.id });
                    updateScreen(order);
                } else {
                    localStorage.removeItem('myOrderId');
                }
            }
        });

        function updateScreen(order) {
            const mainView = document.getElementById('main-view');
            const msgDiv = document.getElementById('message');
            const receiptArea = document.getElementById('receipt-area');

            mainView.style.display = 'none';
            msgDiv.style.display = 'block';

            if (order.status === '調理中') {
                msgDiv.className = 'msg-cooking';
                msgDiv.innerHTML = `注文番号: <strong>${order.id}</strong><br>只今調理中です。<br>そのままお待ちください。`;
                receiptArea.innerHTML = '';
            
            } else if (order.status === '支払い待ち') {
                msgDiv.style.display = 'none';
                receiptArea.innerHTML = `<div style="text-align:center; padding:20px; font-weight:bold; color:red;">呼び出し中！</div>`;
                startAlarm(); // アラーム開始

            } else if (order.status === '提供済み') {
                stopAlarm();
                msgDiv.style.display = 'none';
                showReceipt(order);
            }
        }

        function showReceipt(order) {
            let total = 0;
            let list = '';
            order.items.forEach(i => {
                list += `<li>${i.name} x ${i.quantity}</li>`;
                total += i.price * i.quantity;
            });
            document.getElementById('receipt-area').innerHTML = `
                <div id="receipt">
                    <h2 style="text-align:center;">領収書</h2>
                    <p>注文番号: ${order.id}</p>
                    <p>日付: ${new Date(order.createdAt).toLocaleString()}</p>
                    <hr><ul>${list}</ul><hr>
                    <h3 style="text-align:right;">合計: ${total}円</h3>
                </div>
                <button id="btn-new-order" onclick="resetOrder()">新しい注文をする</button>
            `;
        }

        function resetOrder() {
            if(confirm('トップに戻りますか？')) {
                localStorage.removeItem('myOrderId');
                location.reload();
            }
        }

        document.getElementById('submit-order').addEventListener('click', async () => {
            if(cart.length===0) return alert('カートが空です');
            
            // ★ 音声エンジンの起動（ロック解除）
            initAudio();
            if (audioCtx.state === 'suspended') {
                audioCtx.resume().then(() => {
                    // 無音を一瞬鳴らして完全にアンロック
                    const osc = audioCtx.createOscillator();
                    const gain = audioCtx.createGain();
                    gain.gain.value = 0; // 無音
                    osc.connect(gain); gain.connect(audioCtx.destination);
                    osc.start(); osc.stop(audioCtx.currentTime + 0.1);
                });
            }

            const res = await fetch('/api/order', {
                method:'POST', headers:{'Content-Type':'application/json'},
                body: JSON.stringify({ items: cart })
            });
            const data = await res.json();
            
            if(res.ok) {
                localStorage.setItem('myOrderId', data.orderId);
                socket.emit('register_customer', { order
