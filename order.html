<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>注文画面</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        body { font-family: sans-serif; padding: 20px; padding-bottom: 80px; }
        .menu-item { border: 1px solid #ccc; padding: 10px; margin-bottom: 10px; }
        .price { font-weight: bold; color: #d9534f; }
        button { padding: 10px; cursor: pointer; font-size: 1.1em; }
        
        #message { margin-top: 20px; padding: 15px; font-weight: bold; text-align: center; display: none; }
        .msg-cooking { background: #e2e3e5; color: #383d41; border: 2px solid #d6d8db; }
        
        /* アラーム画面 */
        #alarm-modal {
            display: none;
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(255, 0, 0, 0.95);
            color: white; z-index: 9999;
            flex-direction: column; justify-content: center; align-items: center;
            text-align: center;
        }
        #alarm-modal h1 { font-size: 3em; margin-bottom: 20px; animation: shake 0.5s infinite; }
        #stop-alarm-btn {
            font-size: 1.5em; padding: 20px 40px; background: white; color: red;
            border: none; border-radius: 50px; font-weight: bold; box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        @keyframes shake {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            50% { transform: translate(-1px, 2px) rotate(-1deg); }
            100% { transform: translate(1px, -2px) rotate(-1deg); }
        }

        #receipt { border: 2px dashed #333; background: #fafafa; padding: 15px; margin-top: 20px; }
        #btn-new-order { width: 100%; background: #007bff; color: white; border: none; margin-top: 20px; }
        .quantity-btn { padding: 5px 10px; margin: 0 5px; }
    </style>
</head>
<body>
    <div id="alarm-modal">
        <h1>出来上がり！</h1>
        <p>注文番号の呼び出しです。<br>カウンターへお越しください。</p>
        <button id="stop-alarm-btn" onclick="stopAlarm()">音を止めて確認する</button>
    </div>

    <div id="main-view">
        <h1>ご注文</h1>
        <div id="menu-area">
            <div class="menu-item">
                <h3>牛串★乳成分を含みます★</h3><p class="price">500円</p>
                <button class="add-to-cart" data-name="牛串" data-price="500">カートに入れる</button>
            </div>
        </div>
        <h2>カート</h2>
        <ul id="cart-list"></ul>
        <div id="total">合計: 0円</div>
        <button id="submit-order" style="width:100%; margin-top:10px;">注文する</button>
    </div>

    <div id="message"></div>
    <div id="receipt-area"></div>

    <script>
        // 基本設定
        const socket = io();
        const VAPID_PUBLIC_KEY = 'BAoAi-ufJ4-0DmT7deTIt7XciP2h2uaIT298QxdfBn3YCkM-11mpduc9hkyyHUEUwXqmd-F3it0__q-BDW0-kUk'; 
        let cart = [];

        // HTML要素の取得
        const cartList = document.getElementById('cart-list');
        const totalDiv = document.getElementById('total');

        // ★★★★★ カート機能を最優先で読み込む (ここを一番上に移動) ★★★★★
        document.querySelectorAll('.add-to-cart').forEach(btn => {
            btn.addEventListener('click', e => {
                const name = e.target.getAttribute('data-name');
                const price = parseInt(e.target.getAttribute('data-price'));
                
                // カートに追加
                const exist = cart.find(i => i.name === name);
                if(exist) {
                    exist.quantity++;
                } else {
                    cart.push({name: name, price: price, quantity: 1});
                }
                renderCart();
            });
        });

        // カート描画関数
        function renderCart() {
            cartList.innerHTML = '';
            let t = 0;
            cart.forEach((i, idx) => {
                const li = document.createElement('li');
                li.innerHTML = `${i.name} - ${i.price}円 x ${i.quantity} 
                    <button class="quantity-btn" onclick="modQ(${idx},1)">+</button>
                    <button class="quantity-btn" onclick="modQ(${idx},-1)">-</button>`;
                cartList.appendChild(li);
                t += i.price * i.quantity;
            });
            totalDiv.innerText = `合計: ${t}円`;
        }

        // 数量変更 (+/- ボタン)
        window.modQ = (idx, d) => {
            if (cart[idx]) {
                cart[idx].quantity += d;
                if(cart[idx].quantity <= 0) cart.splice(idx, 1);
                renderCart();
            }
        };
        // ★★★★★ カート機能 ここまで ★★★★★


        // --- 音声・アラーム機能 ---
        let alarmInterval = null;
        let audioCtx = null;

        function initAudio() {
            if (!audioCtx) {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                if (AudioContext) {
                    audioCtx = new AudioContext();
                }
            }
        }

        function playBeep() {
            try {
                if (!audioCtx) initAudio();
                if (!audioCtx) return; // AudioContext非対応ブラウザ対策
                if (audioCtx.state === 'suspended') audioCtx.resume();

                const oscillator = audioCtx.createOscillator();
                const gainNode = audioCtx.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(audioCtx.destination);

                oscillator.type = 'square';
                oscillator.frequency.
