<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>注文画面</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        body { font-family: sans-serif; padding: 20px; }
        .menu-item { border: 1px solid #ccc; padding: 10px; margin-bottom: 10px; }
        .price { font-weight: bold; color: #d9534f; }
        button { padding: 10px; cursor: pointer; font-size: 1.1em; }
        #message { margin-top: 20px; padding: 15px; font-weight: bold; text-align: center; display: none; }
        
        /* 状態ごとのスタイル */
        .msg-cooking { background: #e2e3e5; color: #383d41; border: 2px solid #d6d8db; }
        .msg-ready { background: #f8d7da; color: #721c24; border: 2px solid #f5c6cb; animation: flash 1s infinite; }
        @keyframes flash { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        
        #receipt { border: 2px dashed #333; background: #fafafa; padding: 15px; margin-top: 20px; }
        #btn-new-order { width: 100%; background: #007bff; color: white; border: none; margin-top: 20px; }
        
        /* カート数量ボタン */
        .quantity-btn { padding: 5px 10px; margin: 0 5px; }
    </style>
</head>
<body>
    <div id="main-view">
        <h1>ご注文</h1>
        <div id="menu-area">
            <div class="menu-item">
                <h3>牛串★乳成分を含みます★</h3><p class="price">500円</p>
                <button class="add-to-cart" data-name="牛串" data-price="500">カートに入れる</button>
            </div>
        </div>

        <h2>カート</h2>
        <ul id="cart-list"></ul>
        <div id="total">合計: 0円</div>
        <button id="submit-order" style="width:100%; margin-top:10px;">注文する</button>
    </div>

    <div id="message"></div>
    <div id="receipt-area"></div>

    <script>
        const socket = io();
        const VAPID_PUBLIC_KEY = 'BAoAi-ufJ4-0DmT7deTIt7XciP2h2uaIT298QxdfBn3YCkM-11mpduc9hkyyHUEUwXqmd-F3it0__q-BDW0-kUk'; 
        
        let cart = [];
        const customerCallSound = new Audio('/customer-call.mp3');
        let audioUnlocked = false;

        function playSound() { 
            if (audioUnlocked) { 
                customerCallSound.currentTime = 0; 
                customerCallSound.play().catch(e=>console.log(e)); 
            }
        }

        // 初期化
        document.addEventListener('DOMContentLoaded', async () => {
            const savedId = localStorage.getItem('myOrderId');
            if(savedId) {
                const res = await fetch(`/api/order/${savedId}`);
                if(res.ok) {
                    const order = await res.json();
                    socket.emit('register_customer', { orderId: order.id });
                    updateScreen(order);
                } else {
                    localStorage.removeItem('myOrderId');
                }
            }
        });

        // 画面切り替えロジック
        function updateScreen(order) {
            const mainView = document.getElementById('main-view');
            const msgDiv = document.getElementById('message');
            const receiptArea = document.getElementById('receipt-area');

            // 共通: 注文済みならメイン画面（メニュー）を隠す
            mainView.style.display = 'none';
            msgDiv.style.display = 'block';

            if (order.status === '調理中') {
                msgDiv.className = 'msg-cooking';
                msgDiv.innerHTML = `注文番号: <strong>${order.id}</strong><br>只今調理中です。<br>そのままお待ちください。`;
                receiptArea.innerHTML = '';
            
            } else if (order.status === '支払い待ち') {
                // ★ 厨房で準備完了 -> 呼び出し中
                msgDiv.className = 'msg-ready';
                msgDiv.innerHTML = `注文番号: <strong>${order.id}</strong><br>出来上がりました！<br>レジまでお越しください。`;
                receiptArea.innerHTML = '';
            
            } else if (order.status === '提供済み') {
                // ★ 支払い完了 -> レシート
                msgDiv.style.display = 'none'; // メッセージ消す
                showReceipt(order);
            }
        }

        function showReceipt(order) {
            let total = 0;
            let list = '';
            order.items.forEach(i => {
                list += `<li>${i.name} x ${i.quantity}</li>`;
                total += i.price * i.quantity;
            });
            
            document.getElementById('receipt-area').innerHTML = `
                <div id="receipt">
                    <h2 style="text-align:center;">領収書</h2>
                    <p>注文番号: ${order.id}</p>
                    <p>日付: ${new Date(order.createdAt).toLocaleString()}</p>
                    <hr><ul>${list}</ul><hr>
                    <h3 style="text-align:right;">合計: ${total}円</h3>
                </div>
                <button id="btn-new-order" onclick="resetOrder()">新しい注文をする</button>
            `;
        }

        function resetOrder() {
            if(confirm('トップに戻りますか？')) {
                localStorage.removeItem('myOrderId');
                location.reload();
            }
        }

        // 注文処理
        document.getElementById('submit-order').addEventListener('click', async () => {
            if(cart.length===0) return alert('カートが空です');
            
            // 音声ロック解除
            if(!audioUnlocked) {
                customerCallSound.muted = true;
                customerCallSound.play().then(()=>{ 
                    customerCallSound.pause(); customerCallSound.muted=false; audioUnlocked=true; 
                }).catch(e=>console.log(e));
            }

            const res = await fetch('/api/order', {
                method:'POST', headers:{'Content-Type':'application/json'},
                body: JSON.stringify({ items: cart })
            });
            const data = await res.json();
            
            if(res.ok) {
                localStorage.setItem('myOrderId', data.orderId);
                socket.emit('register_customer', { orderId: data.orderId });
                if ('serviceWorker' in navigator) registerPush(data.orderId);
                
                // 即座に調理中画面へ
                updateScreen({ id: data.orderId, status: '調理中', items: cart });
            }
        });

        // Socketイベント
        socket.on('order_ready', () => {
            // 呼び出し（支払い待ちになった）
            playSound();
            const oid = localStorage.getItem('myOrderId');
            if(oid) updateScreen({ id: oid, status: '支払い待ち' }); // 簡易更新
        });

        socket.on('payment_confirmed', (order) => {
            updateScreen(order); // レシート表示
        });

        // 状態同期用
        socket.on('status_updated', (order) => {
            const oid = localStorage.getItem('myOrderId');
            if(oid && parseInt(oid) === order.id) {
                updateScreen(order);
                if(order.status === '支払い待ち') playSound();
            }
        });

        // カート機能 (省略せず記述)
        const cartList = document.getElementById('cart-list');
        const totalDiv = document.getElementById('total');
        document.querySelectorAll('.add-to-cart').forEach(btn => {
            btn.addEventListener('click', e => {
                const name = e.target.getAttribute('data-name');
                const price = parseInt(e.target.getAttribute('data-price'));
                const exist = cart.find(i=>i.name===name);
                if(exist) exist.quantity++; else cart.push({name, price, quantity:1});
                renderCart();
            });
        });
        function renderCart() {
            cartList.innerHTML = ''; let t=0;
            cart.forEach((i, idx) => {
                cartList.innerHTML += `<li>${i.name} - ${i.price}円 x ${i.quantity} <button onclick="modQ(${idx},1)">+</button><button onclick="modQ(${idx},-1)">-</button></li>`;
                t += i.price * i.quantity;
            });
            totalDiv.innerText = `合計: ${t}円`;
        }
        window.modQ = (idx, d) => {
            cart[idx].quantity += d;
            if(cart[idx].quantity<=0) cart.splice(idx,1);
            renderCart();
        };

        async function registerPush(orderId) {
            try {
                const reg = await navigator.serviceWorker.register('/service-worker.js');
                const perm = await Notification.requestPermission();
                if(perm!=='granted') return;
                const sub = await reg.pushManager.subscribe({userVisibleOnly:true, applicationServerKey: VAPID_PUBLIC_KEY});
                await fetch('/api/subscribe', {method:'POST', body:JSON.stringify({subscription:sub, orderId}), headers:{'Content-Type':'application/json'}});
            } catch(e){}
        }
    </script>
</body>
</html>

